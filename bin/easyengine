#!/bin/bash

# Arguments
EE_FIRST=$1
EE_SECOND=$2
EE_THIRD=$3
EE_FOURTH=$4
EE_FIFTH=$5

# Include library
for ee_include in $(find /usr/local/lib/easyengine/ -iname "*.sh"); do
	source $ee_include
done

# Let's capture the EasyEngine arguments
ee_lib_echo "EasyEngine (ee) execution started [$(date)]" &>> $EE_COMMAND_LOG
ee_lib_echo "EasyEngine (ee) command: $0 $@" &>> $EE_COMMAND_LOG




# EasyEngine version
if [ "$EE_FIRST" = "version" ] || [ "$EE_FIRST" = "--version" ] || [ "$EE_FIRST" = "-v" ]
then
	# Display Easy Engine Version
	echo "EasyEngine (ee) version: $EE_VERSION"

# EasyEngine stack/system
elif [ "$EE_FIRST" = "stack" ] || [ "$EE_FIRST" = "system" ]
then
	# EasyEngine install
	if [ "$EE_SECOND" = "install" ]; then
		if [ "$EE_THIRD" = "nginx" ] || [ "$EE_THIRD" = "php" ] || [ "$EE_THIRD" = "mysql" ] || [ "$EE_THIRD" = "postfix" ] || [ "$EE_THIRD" = "adminer" ] || [ "$EE_THIRD" = "phpmyadmin" ] || [ "$EE_THIRD" = "wpcli" ] || [ "$EE_THIRD" = "utils" ]; then
			if [ "$EE_THIRD" = "nginx" ] || [ "$EE_THIRD" = "php" ]; then
				# Setup nginx/php repository
				ee_mod_repo_$EE_THIRD

				# Fix GnuPG key
				ee_lib_gpg_key_fix
			fi		

			if [ "$EE_THIRD" = "nginx" ] || [ "$EE_THIRD" = "php" ] || [ "$EE_THIRD" = "mysql" ] || [ "$EE_THIRD" = "postfix" ]; then
				# Execute: apt-get update
				ee_lib_apt_get_update	

				# Install nginx/php/mysql/postfix package
				ee_mod_install_$EE_THIRD
			fi

			if [ "$EE_THIRD" = "nginx" ] || [ "$EE_THIRD" = "php" ] || [ "$EE_THIRD" = "mysql" ]; then
				# Setup nginx/php/mysql
				ee_mod_setup_$EE_THIRD
			fi

			if [ "$EE_THIRD" = "nginx" ] || [ "$EE_THIRD" = "php" ] || [ "$EE_THIRD" = "mysql" ] || [ "$EE_THIRD" = "postfix" ]; then
				# Restart php5-fpm
				if [ "$EE_THIRD" = "php" ];then
					ee_lib_service php5-fpm restart

					# Initialize Git
					ee_lib_git_init /etc/php5/
				else
					# Restart nginx/mysql/postfix
					ee_lib_service $EE_THIRD restart
					
					# Initialize Git
					ee_lib_git_init /etc/$EE_THIRD/
				fi
			fi

			if [ "$EE_THIRD" = "adminer" ] || [ "$EE_THIRD" = "phpmyadmin" ] || [ "$EE_THIRD" = "wpcli" ] || [ "$EE_THIRD" = "utils" ];then
				# Install adminer/phpmyadmin/wpcli/utils
				ee_ven_install_$EE_THIRD
			fi

			# Display success message
			ee_lib_echo "$EE_THIRD successfully installed"
		elif [ "$EE_THIRD" = "" ]; then
			# Setup nginx/php repository
			ee_mod_repo_nginx
			ee_mod_repo_php

			# Fix GnuPG key
			ee_lib_gpg_key_fix

			# Execute: apt-get update
			ee_lib_apt_get_update	

			# Install nginx/php/mysql/postfix package
			ee_mod_install_nginx
			ee_mod_install_php
			ee_mod_install_mysql
			ee_mod_install_postfix

			# Setup nginx/php/mysql
			ee_mod_setup_nginx
			ee_mod_setup_php
			ee_mod_setup_mysql

			# # Restart nginx/mysql/postfix
			ee_lib_service nginx php5-fpm mysql restart
					
			# Initialize Git
			ee_lib_git_init /etc/nginx/ /etc/php5/ /etc/mysql/ /etc/postfix

			# Install adminer/phpmyadmin/wpcli/utils
			ee_ven_install_adminer
			ee_ven_install_phpmyadmin
			ee_ven_install_wpcli
			ee_ven_install_utils
		fi
	fi
fi
